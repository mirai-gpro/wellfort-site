---
// src/pages/products/index.astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { supabase } from '../../lib/supabase';

// 商品データを取得
const { data: products, error } = await supabase
  .from('test_products')
  .select('*')
  .eq('is_active', true)
  .order('sort_order', { ascending: true });

if (error) {
  console.error('Error fetching products:', error);
}

// featuresから特徴の配列を取得するヘルパー関数
function getFeaturesList(features: any): string[] {
  if (!features) return [];

  if (features.検査頻度 && Array.isArray(features.検査頻度)) {
    return features.検査頻度;
  }

  if (features.検査内容 && Array.isArray(features.検査内容)) {
    return features.検査内容;
  }

  if (features.特徴 && Array.isArray(features.特徴)) {
    return features.特徴;
  }

  const allArrays: string[] = [];
  for (const key in features) {
    if (Array.isArray(features[key])) {
      allArrays.push(...features[key]);
    }
  }

  return allArrays;
}
---

<BaseLayout title="検査商品一覧 - Wellfort">
  <Header />

  <main>
    <!-- プラン診断セクション -->
    <section id="plan-finder" class="plan-finder-section">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="plan-finder-box fade-in">
          <div class="plan-finder-content">
            <h3 class="plan-finder-title">あなたに合ったプラン診断</h3>
            <p class="plan-finder-description">簡単な質問に答えるだけで、最適なプランをご提案します</p>
            <button class="plan-finder-button" id="openShindanBtn">診断を始める</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 検査商品一覧 -->
    <section id="products" class="products-section">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="section-header fade-in">
          <h2 class="heading-section">検査商品一覧</h2>
          <p class="text-lead">
            あなたに最適な検査をお選びください。<br>
            すべての検査にオンライン面談と医師による解説が含まれます。
          </p>
        </div>

        <div class="products-grid">
          {products && products.map((product, index) => {
            const featuresList = getFeaturesList(product.features);

            return (
              <div class="product-card fade-in" style={`animation-delay: ${index * 0.1}s`}>
                <div class="product-badge">{product.category}</div>

                <div class="product-content">
                  <h3 class="product-name">{product.name}</h3>
                  <p class="product-description">{product.description}</p>

                  {featuresList.length > 0 && (
                    <ul class="product-features">
                      {featuresList.slice(0, 3).map((feature: string) => (
                        <li>
                          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M13.3333 4L6 11.3333L2.66667 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                          {feature}
                        </li>
                      ))}
                    </ul>
                  )}

                  <div class="product-footer">
                    <div class="product-price">
                      <span class="price-label">料金</span>
                      <span class="price-amount">\{product.price.toLocaleString()}</span>
                      <span class="price-tax">（税込）</span>
                    </div>

                    <a href={`/products/${product.id}`} class="product-btn">
                      詳細を見る
                    </a>
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        <div class="products-note fade-in">
          <p>
            ※ すべての検査キットはご自宅に郵送いたします。<br>
            ※ 検査結果は3〜7営業日以内にオンラインでご確認いただけます。
          </p>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</BaseLayout>

<!-- 診断モーダル -->
<div id="shindanModal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <iframe id="shindanIframe" src="" frameborder="0"></iframe>
  </div>
</div>

<style>
  /* プラン診断セクション */
  .plan-finder-section {
    padding: 60px 0;
    background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
  }

  .plan-finder-box {
    background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
  }

  .plan-finder-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 12px;
  }

  .plan-finder-description {
    font-size: 1rem;
    color: #4b5563;
    margin-bottom: 24px;
  }

  .plan-finder-button {
    display: inline-block;
    padding: 14px 48px;
    background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
    color: white;
    border: none;
    border-radius: 50px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(13, 148, 136, 0.4);
  }

  .plan-finder-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(13, 148, 136, 0.5);
  }

  /* 商品一覧セクション */
  .products-section {
    padding: 80px 0;
    background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
  }

  .section-header {
    text-align: center;
    margin-bottom: 60px;
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 32px;
    margin-bottom: 60px;
  }

  .product-card {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    position: relative;
  }

  .product-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(13, 148, 136, 0.2);
  }

  .product-badge {
    position: absolute;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
    color: white;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    z-index: 10;
  }

  .product-content {
    padding: 40px 30px 30px;
  }

  .product-name {
    font-size: 24px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 16px;
    line-height: 1.4;
  }

  .product-description {
    font-size: 15px;
    color: #6b7280;
    line-height: 1.7;
    margin-bottom: 24px;
  }

  .product-features {
    list-style: none;
    margin-bottom: 32px;
    padding: 0;
  }

  .product-features li {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    font-size: 14px;
    color: #4b5563;
    border-bottom: 1px solid #f0f0f0;
  }

  .product-features li:last-child {
    border-bottom: none;
  }

  .product-features svg {
    color: #0d9488;
    flex-shrink: 0;
  }

  .product-footer {
    border-top: 2px solid #f0f0f0;
    padding-top: 24px;
  }

  .product-price {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-bottom: 20px;
  }

  .price-label {
    font-size: 14px;
    color: #9ca3af;
  }

  .price-amount {
    font-size: 36px;
    font-weight: 700;
    color: #1f2937;
  }

  .price-tax {
    font-size: 14px;
    color: #9ca3af;
  }

  .product-btn {
    display: block;
    width: 100%;
    padding: 16px 24px;
    background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
    color: white;
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    text-decoration: none;
  }

  .product-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(13, 148, 136, 0.4);
  }

  .products-note {
    background: #f8f9fa;
    border-left: 4px solid #0d9488;
    padding: 24px;
    border-radius: 8px;
    text-align: center;
  }

  .products-note p {
    font-size: 14px;
    color: #6b7280;
    line-height: 1.8;
    margin: 0;
  }

  /* モーダル */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
  }

  .modal-content {
    background-color: #fff;
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    height: 80vh;
    position: relative;
    overflow: hidden;
  }

  .close-modal {
    position: absolute;
    top: 10px;
    right: 20px;
    color: #333;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    z-index: 10;
  }

  .close-modal:hover {
    color: #0d9488;
  }

  #shindanIframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  @media (max-width: 768px) {
    .plan-finder-section {
      padding: 40px 0;
    }

    .plan-finder-box {
      padding: 30px 20px;
    }

    .plan-finder-title {
      font-size: 1.5rem;
    }

    .products-section {
      padding: 60px 0;
    }

    .products-grid {
      grid-template-columns: 1fr;
      gap: 24px;
    }

    .product-content {
      padding: 30px 20px 20px;
    }

    .product-name {
      font-size: 20px;
    }

    .price-amount {
      font-size: 28px;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('shindanModal');
    const openBtn = document.getElementById('openShindanBtn');
    const closeBtn = document.querySelector('.close-modal');
    const iframe = document.getElementById('shindanIframe') as HTMLIFrameElement;

    if (openBtn && modal && iframe) {
      openBtn.addEventListener('click', () => {
        iframe.src = '/shindan.html';
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
      });
    }

    if (closeBtn && modal && iframe) {
      closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
        iframe.src = '';
        document.body.style.overflow = 'auto';
      });
    }

    window.addEventListener('click', (e) => {
      if (e.target === modal && iframe) {
        modal.style.display = 'none';
        iframe.src = '';
        document.body.style.overflow = 'auto';
      }
    });
  });
</script>
